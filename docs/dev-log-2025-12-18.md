# Snap Plugin 개발 로그 (2025-12-18)

## 완료된 작업

### 1부: Control 모듈 완성

#### 구현 내용
- **Shift+E 트리거**: 이펙트 컨트롤 패널 표시
- **[S] 저장 버튼**: 저장 모드 진입
- **프리셋 슬롯 [1][2][3]**: 이펙트 조합 저장/로드

#### 수정된 파일
1. `cpp/src/modules/control/ControlUI.h` - ACTION_SAVE_PRESET enum 추가
2. `cpp/src/modules/control/ControlUI.cpp` - [S] 버튼, 저장 모드 로직
3. `cpp/src/core/SnapPlugin.cpp` - 프리셋 저장/로드/적용 처리
4. `cep/js/core/settings.js` - effectPresets 기본값 추가

---

### 2부: Keyframe 모듈 신규 개발

#### 개요
- **트리거**: K키 0.4초 홀드
- **핵심 컨셉**: 속도(velocity) 그래프를 정의하고 적분하여 위치 곡선 생성
- **UI**: 프리셋 선택 + 커스텀 커브 편집기

#### 왜 속도 기반인가?
```
Flow (기존): 위치 그래프 → 직접 bezier 조정
Keyframe (새로운): 속도 그래프 → 적분 → 위치 그래프

장점:
- 속도가 "느낌"을 직접 제어
- 적분하면 자연스러운 곡선
- 급격한 속도 변화 없음 (C1 연속성 보장)
```

#### 생성/수정된 파일

##### 새로 생성
1. `cpp/src/modules/keyframe/KeyframeUI.h` - 인터페이스 정의
   - VelocityPreset enum (LINEAR, EASE_IN, EASE_OUT, EASE_IN_OUT, EASE_OUT_IN, CUSTOM)
   - VelocityCurve struct (베지어 제어점)
   - KeyframeInfo struct (AE 키프레임 정보)
   - KeyframeResult struct (결과값)

2. `cpp/src/modules/keyframe/KeyframeUI.cpp` (~750줄)
   - GDI+ 기반 UI 렌더링
   - 속도 그래프 시각화
   - 핸들 드래그로 커브 편집
   - Simpson's rule 적분
   - 프리셋 버튼들

##### 수정됨
3. `cpp/CMakeLists.txt` - keyframe 모듈 추가
4. `cpp/src/core/KeyboardMonitor.h` - KEY_K 추가 (macOS: 0x28, Windows: 0x4B)
5. `cpp/src/core/SnapPlugin.cpp` - K키 0.4초 홀드 감지, KeyframeUI 통합
6. `cep/jsx/snap.jsx` - ExtendScript 함수 추가:
   - `getSelectedKeyframeInfo()` - 선택된 키프레임 정보
   - `applyKeyframeEasing(data)` - 이징 적용
   - `calculateVelocity(prop, time)` - 속도 계산
   - `applyEasingPreset(presetName)` - 프리셋 적용

---

## 핵심 기술 구현

### Simpson's Rule 적분
```cpp
float IntegrateVelocityCurve(const VelocityCurve& curve, float t) {
    const int N = 100;
    float h = t / N;
    float sum = 0;
    for (int i = 0; i <= N; i++) {
        float ti = (float)i * h;
        PointF pt = EvalCubicBezier(ti, ...);
        float vi = pt.Y;
        if (i == 0 || i == N) sum += vi;
        else if (i % 2 == 0) sum += 2 * vi;
        else sum += 4 * vi;
    }
    return (h / 3.0f) * sum;
}
```

### K키 홀드 감지
```cpp
// SnapPlugin.cpp IdleHook
if (KeyboardMonitor::IsKeyHeld(KeyboardMonitor::KEY_K)) {
    if (!g_kWaitingForHold) {
        g_kKeyPressTime = std::chrono::steady_clock::now();
        g_kWaitingForHold = true;
    } else {
        auto elapsed = std::chrono::steady_clock::now() - g_kKeyPressTime;
        if (elapsed >= std::chrono::milliseconds(400)) {
            if (!g_keyframeVisible) {
                KeyframeUI::ShowPanel(mouseX, mouseY);
                g_keyframeVisible = true;
            }
        }
    }
}
```

### ExtendScript 키프레임 이징 적용
```javascript
function applyKeyframeEasing(data) {
    // data = {outSpeed, outInfluence, inSpeed, inInfluence}
    var outEase = new KeyframeEase(data.outSpeed, data.outInfluence);
    var inEase = new KeyframeEase(data.inSpeed, data.inInfluence);

    // 다차원 속성 지원
    var outArray = [];
    var inArray = [];
    for (var d = 0; d < dimCount; d++) {
        outArray.push(outEase);
        inArray.push(inEase);
    }

    prop.setTemporalEaseAtKey(keyIndex, outArray, inArray);
}
```

---

## UI 레이아웃

### Keyframe 패널
```
┌─────────────────────────────────────────────────────┐
│  Keyframe Easing                              [x]   │
├─────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────┐  │
│  │     속도 그래프 (Velocity Graph)              │  │
│  │     ↑                                         │  │
│  │     │    ●───────────●                        │  │
│  │     │   /             \                       │  │
│  │     │  ●               ●                      │  │
│  │     └────────────────────→ 시간              │  │
│  └───────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────┤
│  [Linear] [EaseIn] [EaseOut] [InOut] [OutIn]       │
├─────────────────────────────────────────────────────┤
│  Out: spd=0.00 inf=33.33%                          │
│  In:  spd=0.00 inf=33.33%                          │
├─────────────────────────────────────────────────────┤
│  [1] [2] [3]  [Save]                               │
└─────────────────────────────────────────────────────┘
```

---

## 다음 단계 (선택사항)

1. 빌드 테스트 (GitHub Actions)
2. 실제 AE에서 테스트
3. macOS 구현 (현재 stub)
4. 추가 프리셋 커브
5. 키프레임 선택 UI 개선

---

## 데이터 흐름

### Keyframe 이징 적용
```
K키 0.4초 홀드 → 패널 표시
    ↓
속도 그래프에서 커브 조정 (드래그)
    ↓
K키 떼기 → KeyframeResult 반환
    ↓
SnapPlugin: 속도 커브 → 적분 → AE ease 변환
    ↓
snap.jsx: applyKeyframeEasing() 호출
    ↓
After Effects: 키프레임 이징 적용
```
