name: Build Windows Plugin

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Windows SDK 22621
      shell: pwsh
      run: |
        $url = "https://go.microsoft.com/fwlink/?linkid=2196241"
        $installer = "$env:TEMP\winsdksetup.exe"
        Write-Host "Downloading Windows SDK 22621..."
        Invoke-WebRequest -Uri $url -OutFile $installer
        Write-Host "Installing Windows SDK 22621..."
        Start-Process -FilePath $installer -ArgumentList "/features OptionId.DesktopCPPx64 /quiet /norestart" -Wait
        Remove-Item $installer
        Write-Host "SDK 22621 installed successfully"
    
    - name: Setup MSVC with SDK 22621
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        sdk: '10.0.22621.0'
    
    - name: Generate PiPL Resource
      run: |
        cpp\resources\PiPLtool.exe cpp\resources\AnchorRadialMenu_PiPL.r cpp\resources\win\AnchorRadialMenu_PiPL_temp.rc
        
    - name: Configure CMake
      run: |
        cmake -S cpp -B cpp/build -DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_VERSION=10.0.22621.0
      
    - name: Build Plugin with SDK 22621
      run: |
        cmake --build cpp/build --config Release -- /p:WindowsTargetPlatformVersion=10.0.22621.0
        
    - name: Prepare Artifacts & Installer
      run: |
        mkdir release
        mkdir release\AnchorGrid
        mkdir release\AnchorGrid\plugin
        mkdir release\AnchorGrid\cep
        
        # Copy compiled plugin (.aex)
        copy cpp\build\Release\AnchorRadialMenu.aex release\AnchorGrid\plugin\AnchorRadialMenu.aex
        
        # Copy CEP panel (full folder)
        xcopy cep release\AnchorGrid\cep /E /I /Y
        
        # Copy Install Script
        copy install_windows.bat release\AnchorGrid\install.bat

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AnchorGrid_Windows_Installer
        path: release/AnchorGrid
