name: Build Windows Plugin

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Generate PiPL Resource
      run: |
        # Run PiPLtool to convert .r to .rc format
        # PiPLtool.exe <input.r> <output_temp.rc>
        cpp\resources\PiPLtool.exe cpp\resources\AnchorRadialMenu_PiPL.r cpp\resources\win\AnchorRadialMenu_PiPL_temp.rc
        
    - name: Configure CMake
      run: cmake -S cpp -B cpp/build -DCMAKE_BUILD_TYPE=Release
      
    - name: Build Plugin
      run: cmake --build cpp/build --config Release --verbose
      
    - name: Prepare Artifacts & Installer
      run: |
        mkdir release
        mkdir release\AnchorGrid
        mkdir release\AnchorGrid\plugin
        mkdir release\AnchorGrid\cep
        
        # Copy compiled plugin (CMake outputs .aex directly as per CMakeLists.txt)
        copy cpp\build\Release\AnchorRadialMenu.aex release\AnchorGrid\plugin\AnchorRadialMenu.aex
        
        # Copy CEP panel
        xcopy /E /I /Y cep release\AnchorGrid\cep
        
        # Copy Install Script
        copy install_windows.bat release\AnchorGrid\install.bat

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AnchorGrid_Windows_Installer
        path: release/AnchorGrid
