name: Build CommandLogger

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Generate PiPL resource
      run: |
        cd tools/CommandLogger
        ..\..\cpp\resources\PiPLtool.exe CommandLogger_PiPL.r CommandLogger_PiPL_temp.rc
      shell: cmd

    - name: Configure CMake
      run: |
        cd tools/CommandLogger
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64
      shell: cmd

    - name: Build Release
      run: |
        cd tools/CommandLogger/build
        cmake --build . --config Release
      shell: cmd

    - name: Find built plugin
      run: |
        $plugin = Get-ChildItem -Path tools/CommandLogger/build -Recurse -Filter "*.aex" | Select-Object -First 1
        if ($plugin) {
          Write-Host "Found plugin: $($plugin.FullName)"
        } else {
          Write-Host "No .aex file found"
          exit 1
        }
      shell: pwsh

    - name: Upload CommandLogger
      uses: actions/upload-artifact@v4
      with:
        name: CommandLogger-Build${{ github.run_number }}
        path: tools/CommandLogger/build/**/Release/*.aex
        if-no-files-found: error
